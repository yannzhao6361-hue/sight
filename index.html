<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä¸“ä¸šçº§ E å­—è§†åŠ›æµ‹è¯•ç³»ç»Ÿ (V12.0)</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #eef4f8;
        }
        #app-container {
            max-width: 1000px;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background-color: #fff;
            padding: 20px;
        }
        #e-chart {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background-color: #eee;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        #e-sign {
            font-family: monospace;
            font-size: 200px; 
            font-weight: bold;
            line-height: 1;
            transform-origin: center center;
            color: #000;
        }
        /* Eå­—æ—‹è½¬æ ·å¼ */
        .rotated-0 { transform: rotate(0deg); }
        .rotated-90 { transform: rotate(90deg); }
        .rotated-180 { transform: rotate(180deg); }
        .rotated-270 { transform: rotate(270deg); }

        .control-section {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f7f7f7;
            flex-wrap: wrap;
        }
        .input-group { margin: 5px 10px; }
        .input-group label { font-weight: bold; }

        .status-box {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status-info { background-color: #e0f7fa; color: #007bb6; }
        .status-error { background-color: #ffebee; color: #d32f2f; }
        .status-success { background-color: #e8f5e9; color: #388e3c; }

        .key-prompt {
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 0 5px;
            display: inline-block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        /* è“è‰²æ ¡å‡† E å­—æ ·å¼ */
        #calibration-e {
            color: blue;
            line-height: 1;
            font-weight: bold;
            display: inline-block;
        }
        /* é»˜è®¤éšè—æµ‹è¯•åŒºåŸŸ */
        #test-setup, #test-area, #results-section, #advice-section {
            display: none; 
        }
        .action-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            margin: 5px;
            white-space: nowrap; 
        }
        #direction-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin: 15px 0;
        }
        #direction-controls .row {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        #direction-controls button {
            width: 80px;
            height: 40px;
            margin: 5px;
            font-size: 16px;
            font-weight: bold;
            background-color: #03a9f4;
            color: white;
        }

        /* å»ºè®®æŠ¥å‘Šæ ·å¼ */
        #advice-section {
            text-align: left;
            margin-top: 25px;
            padding: 20px;
            border: 2px solid #00bcd4;
            border-radius: 8px;
            background-color: #e0f7fa;
        }
        #advice-section h3 {
            color: #007bb6;
            border-bottom: 2px solid #00bcd4;
            padding-bottom: 5px;
            margin-top: 0;
        }
        #advice-list li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        /* ç‰ˆæƒå£°æ˜æ ·å¼ */
        #footer-copyright {
            margin-top: 30px;
            padding: 10px 0;
            border-top: 1px solid #ccc;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
<div id="app-container">
    <h1 style="background-color: #e0ffff;">ä¸“ä¸šçº§AIè§†åŠ›æµ‹è¯•ç³»ç»Ÿ   </h1>

    <div id="calibration-section">
        <h2>ğŸ“ ç¬¬ä¸€æ­¥ï¼šå±å¹•ç‰©ç†å°ºå¯¸æ ¡å‡† (å…³é”®!)</h2>
 

        <p>è¯·ä½¿ç”¨å°ºå­ç²¾ç¡®æµ‹é‡ä¸‹æ–¹è“è‰² E å­—çš„**å®é™…ç‰©ç†é«˜åº¦**ï¼Œå¹¶åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨æµ‹å¾—çš„**æ¯«ç±³æ•° (mm)**ï¼š</p>
        <div id="e-chart" style="min-height: 150px;">
            <div id="calibration-e" style="font-size: 50px;">E</div> 
        </div>
        <p>æ ‡å‡†é«˜åº¦ (5.0è§†åŠ›åœ¨ 5m å¤„) åº”ä¸º **7.27 mm**ã€‚</p>
        <label for="measured-height">å®æµ‹è“è‰² E å­—é«˜åº¦ (mm): </label>
        <input type="number" id="measured-height" value="10" step="0.5" style="width: 80px;">
        <button id="calibrate-btn" onclick="window.calibrateScreen()" class="action-button" style="background-color: #03a9f4; color: white;">æ‰§è¡Œæ ¡å‡†</button>
        <p id="calibration-status" class="status-info">ç­‰å¾…æ ¡å‡†...</p>
    </div>

    <div id="test-setup">
        <h2>ğŸ‘¤ ç¬¬äºŒæ­¥ï¼šä¿¡æ¯ä¸ç¯å¢ƒå‡†å¤‡</h2>
        <div class="control-section">
            <div class="input-group">
                <label>å§“å:</label> <input type="text" id="user-name" value="é’å°‘å¹´æµ‹è¯•è€…" required>
            </div>
            <div class="input-group">
                <label>æµ‹è¯•è·ç¦» (ç±³):</label> <input type="number" id="test-distance" value="5" step="0.5" style="width: 60px;">
            </div>
            <div class="input-group">
                <label>å½“å‰æµ‹è¯•çœ¼:</label> <span id="current-eye-display" style="color: red; font-size: 1.2em;">å³çœ¼ (OD)</span>
            </div>
            <button id="start-current-eye-btn" class="action-button" style="background-color: #4CAF50; color: white;">å¼€å§‹å³çœ¼æµ‹è¯•</button>
            <button id="reset-calibration-btn" class="action-button" style="background-color: #ff9800; color: white;">é‡æ–°æ ¡å‡†</button>
        </div>
    </div>

    <div id="test-area">
        <h2>ğŸ‘€ ç¬¬ä¸‰æ­¥ï¼šE å­—è§†åŠ›æµ‹è¯•</h2>
        <div id="e-chart" style="min-height: 400px;">
            <div id="e-sign">E</div>
        </div>
        <div class="status-box status-info">
            å½“å‰è§†åŠ›ç­‰çº§: <span id="current-level-display" style="font-size: 1.5em;"></span>
        </div>

        <div id="direction-controls">
            <div class="row">
                <button data-direction="LEFT">â¬†ï¸ ä¸Š</button>
            </div>
            <div class="row">
                <button data-direction="DOWN">â¬…ï¸ å·¦</button>
                <button data-direction="UP">å³ â¡ï¸</button>
            </div>
            <div class="row">
                <button data-direction="RIGHT">â¬‡ï¸ ä¸‹</button>
            </div>
        </div>
        <div class="control-section">
            <h3>å¿«æ·é”®æ“ä½œå°</h3>
            <p>ï¼ˆé€‚ç”¨äºæ“ä½œå‘˜å¿«é€Ÿè®°å½•ï¼Œæ— éœ€çœ¼ç›ç¦»å¼€è¢«æµ‹è€…ï¼‰</p>
            <p>
                **æ­£ç¡®:** <span class="key-prompt">ç©ºæ ¼ (Space)</span> | **é”™è¯¯:** <span class="key-prompt">Enter</span> | **ç»“æŸæœ¬çœ¼æµ‹è¯•:** <span class="key-prompt">Esc</span>
            </p>
            <p>
                **å½“å‰è¡Œè®°å½•:** æ­£ç¡® <span id="correct-count" style="color: green;">0</span>, é”™è¯¯ <span id="error-count" style="color: red;">0</span>
            </p>
        </div>
    </div>

    <div id="results-section">
        <h2>ğŸ“‹ ç¬¬å››æ­¥ï¼šæµ‹è¯•ç»“æœä¸æŠ¥å‘Š</h2>
        <table id="result-table">
            <tr>
                <th>å§“å</th>
                <th>æµ‹è¯•è·ç¦»</th>
                <th>å³çœ¼è§†åŠ› (OD)</th>
                <th>å·¦çœ¼è§†åŠ› (OS)</th>
                <th>æµ‹è¯•æ—¥æœŸ</th>
            </tr>
            <tr>
                <td id="res-name"></td>
                <td id="res-distance"></td>
                <td id="res-right">å¾…æµ‹</td>
                <td id="res-left">å¾…æµ‹</td>
                <td id="res-date"></td>
            </tr>
        </table>
        <div style="margin-top: 20px;">
            <button onclick="printReport()" class="action-button" style="background-color: #9c27b0; color: white;">æ‰“å°æŠ¥å‘Š</button>
        </div>
    </div>
    
    <div id="advice-section">
        <h3>ğŸ’¡ è§†åŠ›ä¿æŠ¤å’Œè°ƒç†å»ºè®®</h3>
        <ul id="advice-list">
            </ul>
    </div>

    <div id="footer-copyright">
        &copy; 2023 - <span id="current-year"></span> ä¸“ä¸šçº§AIè§†åŠ›æµ‹è¯•ç³»ç»Ÿ | ç‰ˆæƒæ‰€æœ‰
        <br>
        åœ°å€ï¼šåŒ—äº¬å¸‚ä¸œåŸåŒºå’Œå¹³æ–°åŸç‰©ç¾ä¸€æ¥¼é“­ç†™è§†å…‰ä¸­å¿ƒ            è”ç³»ç”µè¯ï¼š3552346520
    </div>
    </div>

    <script>
        const VISION_CHART = [
            { level: '4.3', acuity: 0.2, sizeMM: 36.36 },
            { level: '4.4', acuity: 0.25, sizeMM: 29.08 },
            { level: '4.5', acuity: 0.3, sizeMM: 24.24 },
            { level: '4.6', acuity: 0.4, sizeMM: 18.18 },
            { level: '4.7', acuity: 0.5, sizeMM: 14.54 },
            { level: '4.8', acuity: 0.6, sizeMM: 12.12 },
            { level: '4.9', acuity: 0.8, sizeMM: 9.09 },
            { level: '5.0', acuity: 1.0, sizeMM: 7.27 }, 
            { level: '5.1', acuity: 1.2, sizeMM: 6.06 },
            { level: '5.2', acuity: 1.5, sizeMM: 4.85 }
        ];

        const CALIBRATION_E_SIZE_PX = 50; 

        let pixelsPerMM = 0; 
        let currentLevelIndex = 0; 
        let currentEye = 'right'; 
        let currentTargetDirection = ''; 
        let rowRecord = []; 
        let testResults = { right: 'å¾…æµ‹', left: 'å¾…æµ‹' };
        let isTesting = false;

        // DOM å…ƒç´ å¼•ç”¨
        const eSign = document.getElementById('e-sign');
        const calibrationE = document.getElementById('calibration-e');
        const calibrationBtn = document.getElementById('calibrate-btn');
        const resetCalibrationBtn = document.getElementById('reset-calibration-btn');
        const startCurrentEyeBtn = document.getElementById('start-current-eye-btn'); 
        const directionControls = document.getElementById('direction-controls'); 
        const currentLevelDisplay = document.getElementById('current-level-display');
        const currentEyeDisplay = document.getElementById('current-eye-display');
        const correctCountDisplay = document.getElementById('correct-count');
        const errorCountDisplay = document.getElementById('error-count');
        const calibrationStatus = document.getElementById('calibration-status');
        const adviceSection = document.getElementById('advice-section'); 
        const adviceList = document.getElementById('advice-list'); 

        // --- æ ¸å¿ƒæ ¡å‡†é€»è¾‘ (å®šä¹‰ä¸ºå…¨å±€å‡½æ•°ï¼Œä»¥ä¾¿å†…è” onclick è®¿é—®) ---
        window.calibrateScreen = function() {
            console.log('Calibration button clicked! (From JS or Onclick)');

            if (pixelsPerMM > 0 && calibrationBtn.textContent === 'å·²æ ¡å‡†') {
                 console.log('Already calibrated. Ignoring click.');
                 return;
            }
            
            const measuredHeight = parseFloat(document.getElementById('measured-height').value);
            
            if (isNaN(measuredHeight) || measuredHeight <= 0) {
                calibrationStatus.className = 'status-error';
                calibrationStatus.textContent = 'è¾“å…¥æ— æ•ˆï¼Œè¯·è¾“å…¥å¤§äº0çš„å®æµ‹é«˜åº¦ (mm)ã€‚';
                console.error('Calibration failed: Invalid input.');
                return;
            }

            pixelsPerMM = CALIBRATION_E_SIZE_PX / measuredHeight;

            calibrationStatus.className = 'status-success';
            calibrationStatus.textContent = `æ ¡å‡†æˆåŠŸï¼å±å¹•å¯†åº¦çº¦ä¸º ${pixelsPerMM.toFixed(2)} px/mmã€‚`;
            
            calibrationBtn.style.backgroundColor = '#4CAF50';
            calibrationBtn.textContent = 'å·²æ ¡å‡†';

            document.getElementById('calibration-section').style.display = 'none';
            document.getElementById('test-setup').style.display = 'block';
            document.getElementById('results-section').style.display = 'block';
            
            calibrationE.style.display = 'none'; 
            
            document.getElementById('res-name').textContent = document.getElementById('user-name').value;
            document.getElementById('res-distance').textContent = document.getElementById('test-distance').value + ' m';
            document.getElementById('res-date').textContent = new Date().toLocaleDateString();
            
            console.log(`Calibration successful: ${pixelsPerMM.toFixed(2)} px/mm.`);
        }

        // --- é‡ç½®æ ¡å‡† ---
        function resetCalibration() {
            if (isTesting) {
                alert('è¯·å…ˆå®Œæˆæˆ–ç»“æŸå½“å‰çœ¼çš„æµ‹è¯•ï¼');
                return;
            }
            if (!confirm('ç¡®å®šè¦é‡æ–°æ ¡å‡†å—ï¼Ÿè¿™å°†æ¸…é™¤å½“å‰çš„æ ¡å‡†æ•°æ®ã€‚')) {
                return;
            }
            
            pixelsPerMM = 0;
            calibrationStatus.className = 'status-info';
            calibrationStatus.textContent = 'ç­‰å¾…æ ¡å‡†...';
            
            calibrationBtn.style.backgroundColor = '#03a9f4';
            calibrationBtn.textContent = 'æ‰§è¡Œæ ¡å‡†';
            
            document.getElementById('calibration-section').style.display = 'block';
            document.getElementById('test-setup').style.display = 'none';
            document.getElementById('test-area').style.display = 'none';
            document.getElementById('results-section').style.display = 'none';
            adviceSection.style.display = 'none'; 
            
            calibrationE.style.display = 'inline-block';
        }

        // --- æµ‹è¯•æµç¨‹æ§åˆ¶ ---

        function startTest(eye) {
            if (pixelsPerMM === 0) {
                alert('è¯·å…ˆå®Œæˆå±å¹•æ ¡å‡†ï¼');
                return;
            }
            
            currentEye = eye;
            currentEyeDisplay.textContent = eye === 'right' ? 'å³çœ¼ (OD)' : 'å·¦çœ¼ (OS)';

            if (testResults[eye] !== 'å¾…æµ‹') {
                if (!confirm(`æ‚¨å·²æµ‹è¯•è¿‡${currentEyeDisplay.textContent}ï¼Œç¡®å®šé‡æ–°æµ‹è¯•å—ï¼Ÿ`)) {
                    return;
                }
            }
            
            adviceSection.style.display = 'none'; 

            isTesting = true;
            currentLevelIndex = 0; 
            rowRecord = [];
            
            document.getElementById('test-setup').style.display = 'none';
            document.getElementById('test-area').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';

            updateEsignAndStatus(currentLevelIndex);
            generateESign();
        }

        function updateEsignAndStatus(index) {
            const current = VISION_CHART[index];
            const sizePx = current.sizeMM * pixelsPerMM;
            eSign.style.fontSize = `${sizePx}px`;
            currentLevelDisplay.textContent = `${current.level} (${current.acuity}) | Eå­—é«˜: ${current.sizeMM.toFixed(2)} mm`;
            correctCountDisplay.textContent = rowRecord.filter(r => r).length;
            errorCountDisplay.textContent = rowRecord.filter(r => !r).length;
        }

        function generateESign() {
            const directions = ['UP', 'RIGHT', 'DOWN', 'LEFT'];
            const randomDirection = directions[Math.floor(Math.random() * directions.length)];
            currentTargetDirection = randomDirection;

            const rotationMap = { 'UP': 0, 'RIGHT': 90, 'DOWN': 180, 'LEFT': 270 };
            eSign.className = `rotated-${rotationMap[randomDirection]}`;
        }

        function recordAnswerDirection(direction) {
            if (!isTesting) return;
            const isCorrect = direction === currentTargetDirection;
            recordAnswer(isCorrect); 
        }

        function recordAnswer(isCorrect) {
            if (!isTesting) return;
            rowRecord.push(isCorrect);
            correctCountDisplay.textContent = rowRecord.filter(r => r).length;
            errorCountDisplay.textContent = rowRecord.filter(r => !r).length;
            checkRowCompletion();
        }

        function checkRowCompletion() {
            const currentCorrect = rowRecord.filter(r => r).length;
            const currentError = rowRecord.filter(r => !r).length;
            
            if (currentError >= 3) {
                endTestEye(currentLevelIndex === 0 ? 0 : currentLevelIndex - 1); 
                return;
            } 
            
            if (currentCorrect >= 5) {
                
                if (currentLevelIndex === VISION_CHART.length - 1) {
                    endTestEye(currentLevelIndex); 
                    return;
                }
                
                alert(`è§†åŠ› ${VISION_CHART[currentLevelIndex].level} é€šè¿‡ï¼å¼€å§‹æµ‹è¯•ä¸‹ä¸€è¡Œ (${VISION_CHART[currentLevelIndex + 1].level})`);
                currentLevelIndex++;
                rowRecord = []; 
                updateEsignAndStatus(currentLevelIndex);
                generateESign();

            } else if (currentCorrect + currentError >= 8) {
                endTestEye(currentLevelIndex === 0 ? 0 : currentLevelIndex - 1);
            } else {
                generateESign();
            }
        }

        function endTestEye(resultIndex) {
            isTesting = false;
            let finalLevel = '';

            if (resultIndex === 0 && rowRecord.filter(r => !r).length >= 3) {
                finalLevel = '< 4.3';
            } else if (resultIndex < 0) {
                 finalLevel = '< 4.3';
            } else {
                finalLevel = VISION_CHART[resultIndex].level;
            }
            
            alert(`${currentEyeDisplay.textContent} æµ‹è¯•ç»“æŸï¼Œè§†åŠ›ç»“æœä¸ºï¼š${finalLevel}`);
            
            testResults[currentEye] = finalLevel;
            
            document.getElementById('res-right').textContent = testResults.right;
            document.getElementById('res-left').textContent = testResults.left;

            document.getElementById('test-area').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';
            
            document.getElementById('test-setup').style.display = 'block';
            
            // å¼•å¯¼ä¸‹ä¸€æ¬¡æµ‹è¯•
            if (currentEye === 'right' && testResults.left === 'å¾…æµ‹') {
                currentEye = 'left';
                currentEyeDisplay.textContent = 'å·¦çœ¼ (OS)';
                startCurrentEyeBtn.textContent = 'å¼€å§‹å·¦çœ¼æµ‹è¯•';
            } else {
                currentEye = 'right'; 
                currentEyeDisplay.textContent = 'å³çœ¼ (OD)';
                startCurrentEyeBtn.textContent = 'å¼€å§‹å³çœ¼æµ‹è¯•';
            }

            // å¦‚æœå·¦å³çœ¼éƒ½æµ‹å®Œäº†ï¼Œç”Ÿæˆå»ºè®®
            if (testResults.right !== 'å¾…æµ‹' && testResults.left !== 'å¾…æµ‹') {
                generateAdvice();
            }
        }

        // --- æ ¸å¿ƒï¼šæ ¹æ®æµ‹è¯•ç»“æœç”Ÿæˆå»ºè®® ---
        function generateAdvice() {
            adviceList.innerHTML = '';
            
            const getNumericLevel = (result) => {
                const num = parseFloat(result);
                return isNaN(num) ? 4.0 : num;
            };

            const rightLevel = getNumericLevel(testResults.right);
            const leftLevel = getNumericLevel(testResults.left);
            
            let adviceHtml = '';
            let generalAdvice = [];
            let needsAttention = false;

            // 1. è§†åŠ›ç­‰çº§åˆ¤æ–­ (ä»¥è¾ƒå·®çš„çœ¼ç›ä¸ºå‡†)
            const minLevel = Math.min(rightLevel, leftLevel);
            
            if (minLevel >= 5.0) {
                adviceHtml += '<li>ğŸ‰ **è§†åŠ›ä¼˜ç§€ (5.0 åŠä»¥ä¸Š):** ç›®å‰è§†åŠ›çŠ¶å†µè‰¯å¥½ï¼Œè¯·ç»§ç»­ä¿æŒè‰¯å¥½çš„ç”¨çœ¼ä¹ æƒ¯ã€‚</li>';
            } else if (minLevel >= 4.7) {
                adviceHtml += '<li>ğŸ‘ **è§†åŠ›è‰¯å¥½ (4.7-4.9):** è§†åŠ›å¼€å§‹å‡ºç°æ³¢åŠ¨æˆ–è½»å¾®ä¸‹é™è¶‹åŠ¿ã€‚**éœ€è¦é‡ç‚¹å…³æ³¨å’Œè°ƒæ•´ç”¨çœ¼ä¹ æƒ¯ã€‚**</li>';
                needsAttention = true;
            } else if (minLevel >= 4.5) {
                adviceHtml += '<li>âš ï¸ **è§†åŠ›æ¬ ä½³ (4.5-4.6):** å¯èƒ½æ˜¯è½»åº¦è¿‘è§†æˆ–è§†ç–²åŠ³ã€‚**å»ºè®®åˆ°ä¸“ä¸šæœºæ„è¿›è¡Œæ•£ç³éªŒå…‰æ£€æŸ¥ã€‚**</li>';
                needsAttention = true;
            } else { 
                 adviceHtml += '<li>ğŸš¨ **è§†åŠ›è¾ƒå·® (< 4.5):** è§†åŠ›æ˜æ˜¾ä½äºæ­£å¸¸æ°´å¹³ï¼Œæœ‰ä¸­åº¦è¿‘è§†æˆ–æ›´å¤æ‚çœ¼ç—…çš„é£é™©ã€‚**å¯å‰å¾€é“­ç†™è§†å…‰ä¸­å¿ƒè¿›è¡Œè°ƒç†**</li>';
                 needsAttention = true;
            }

            // 2. å·®å¼‚æ€§åˆ¤æ–­ 
            if (rightLevel > 4.3 && leftLevel > 4.3 && Math.abs(rightLevel - leftLevel) > 0.3) {
                generalAdvice.push('**åŒçœ¼è§†åŠ›å·®å¼‚å¤§:** å­˜åœ¨æ˜æ˜¾çš„å±ˆå…‰å‚å·®ï¼Œå¯èƒ½å¯¼è‡´è§†è§‰ç–²åŠ³æˆ–å•çœ¼å¼±è§†é£é™©ï¼Œ**å¿…é¡»å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿè¿›è¡ŒçŸ«æ­£ã€‚**');
            }

            // 3. é€šç”¨ä¿æŠ¤å»ºè®®
            generalAdvice.push('**æˆ·å¤–æ´»åŠ¨:** åšæŒæ¯å¤© 2 å°æ—¶ä»¥ä¸Šçš„æˆ·å¤–é˜³å…‰æ´»åŠ¨ï¼Œè¿™æ˜¯é¢„é˜²è¿‘è§†æœ€æœ‰æ•ˆçš„æ–¹æ³•ä¹‹ä¸€ã€‚');
            generalAdvice.push('**ç”¨çœ¼è·ç¦»:** ä¿æŒâ€œä¸€å°ºã€ä¸€æ‹³ã€ä¸€å¯¸â€çš„åŸåˆ™ï¼ˆä¹¦æœ¬ç¦»çœ¼ä¸€å°ºï¼Œèƒ¸å£ç¦»æ¡Œä¸€æ‹³ï¼Œæ¡ç¬”å¤„ç¦»æŒ‡å°–ä¸€å¯¸ï¼‰ã€‚');
            generalAdvice.push('**ä¼‘æ¯åŸåˆ™:** ä¸¥æ ¼æ‰§è¡Œâ€œ20-20-20â€æ³•åˆ™ï¼šæ¯è¿‘è·ç¦»ç”¨çœ¼ 20 åˆ†é’Ÿï¼Œçœºæœ› 20 è‹±å°ºï¼ˆ6ç±³ï¼‰ä»¥å¤–è‡³å°‘ 20 ç§’ã€‚');
            generalAdvice.push('**å……è¶³ç¡çœ :** ä¿è¯å……è¶³ã€é«˜è´¨é‡çš„ç¡çœ ï¼Œè®©çœ¼éƒ¨è‚Œè‚‰å¾—åˆ°å……åˆ†ä¼‘æ¯ã€‚');
            generalAdvice.push('**é¥®é£Ÿè°ƒç†:** å¤šåƒå¯Œå«ç»´ç”Ÿç´  A (èƒ¡èåœã€æ·±ç»¿è‰²è”¬èœ) å’Œå¶é»„ç´  (ç‰ç±³ã€è›‹é»„ã€ç»¿å¶è”¬èœ) çš„é£Ÿç‰©ã€‚');
            
            if (needsAttention) {
                generalAdvice.push('**å®šæœŸå¤æŸ¥:** å»ºè®®æ¯ 3-6 ä¸ªæœˆè¿›è¡Œä¸€æ¬¡ä¸“ä¸šçš„è§†åŠ›æ£€æŸ¥å’Œçœ¼è½´æµ‹é‡ã€‚');
            }

            // æ¸²æŸ“å»ºè®®
            adviceHtml += generalAdvice.map(item => `<li>${item}</li>`).join('');
            
            adviceList.innerHTML = adviceHtml;
            adviceSection.style.display = 'block';
        }


        function printReport() {
            window.print();
        }

        // --- æ ¸å¿ƒäº‹ä»¶ç»‘å®š (ä½¿ç”¨ DOMContentLoaded) ---

        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®å½“å‰å¹´ä»½
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // 1. ç»‘å®š æ ¡å‡†æŒ‰é’® (è™½ç„¶å·²è®¾ç½® onclickï¼Œä½†ä¿ç•™ addEventListener ä½œä¸ºç¬¬äºŒé“ä¿é™©)
            calibrationBtn.addEventListener('click', window.calibrateScreen);

            // 2. ç»‘å®š é‡æ–°æ ¡å‡†æŒ‰é’®
            resetCalibrationBtn.addEventListener('click', resetCalibration);
            
            // 3. ç»‘å®š "å¼€å§‹å½“å‰çœ¼æµ‹è¯•" æŒ‰é’®
            startCurrentEyeBtn.addEventListener('click', () => startTest(currentEye)); 

            // 4. ç»‘å®š é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                if (!isTesting) return;
                
                if (e.key === ' ') { 
                    e.preventDefault();
                    recordAnswer(true); 
                } else if (e.key === 'Enter') { 
                    e.preventDefault();
                    recordAnswer(false); 
                } else if (e.key === 'Escape') { 
                    endTestEye(currentLevelIndex === 0 ? 0 : currentLevelIndex - 1); 
                }
            });

            // 5. ç»‘å®š æ–¹å‘æ§åˆ¶æŒ‰é’® (äº‹ä»¶å§”æ‰˜)
            directionControls.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.hasAttribute('data-direction')) {
                    const direction = e.target.getAttribute('data-direction');
                    recordAnswerDirection(direction);
                }
            });
            
            // åˆå§‹è®¾ç½®ç¬¬äºŒæ­¥æŒ‰é’®æ–‡æœ¬
            startCurrentEyeBtn.textContent = 'å¼€å§‹å³çœ¼æµ‹è¯•';
        });
    </script>
</body>
</html>